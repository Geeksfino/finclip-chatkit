# ä¸Šä¸‹æ–‡æä¾›å™¨æŒ‡å—

æœ¬æŒ‡å—ä»‹ç»å¦‚ä½•ä¸º ChatKit å®ç°è‡ªå®šä¹‰ä¸Šä¸‹æ–‡æä¾›å™¨ï¼Œå…è®¸ç”¨æˆ·å°†å„ç§ç±»å‹çš„ä¸Šä¸‹æ–‡ï¼ˆç…§ç‰‡ã€ä½ç½®ã€æ–‡ä»¶ã€ç¬”è®°ç­‰ï¼‰é™„åŠ åˆ°æ¶ˆæ¯ä¸­ã€‚ä¸Šä¸‹æ–‡æä¾›å™¨æ˜¯"å°ç¨‹åº"ï¼Œè®©æ‚¨å®Œå…¨æ§åˆ¶æ”¶é›†ã€é¢„è§ˆå’Œæ˜¾ç¤ºä¸Šä¸‹æ–‡çš„ç”¨æˆ·ä½“éªŒã€‚

> **ğŸ“˜ æ³¨æ„ï¼š** ä¸Šä¸‹æ–‡æä¾›å™¨åŸºäº ConvoUI çš„ä¸Šä¸‹æ–‡æä¾›å™¨ç³»ç»Ÿæ„å»ºã€‚æœ¬æŒ‡å—æ¶µç›– Swift å’Œ Objective-C ä¸¤ç§å®ç°æ–¹å¼ã€‚

---

## ç›®å½•

1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [æ¶æ„](#æ¶æ„)
3. [å®ç°ä¸Šä¸‹æ–‡æä¾›å™¨](#å®ç°ä¸Šä¸‹æ–‡æä¾›å™¨)
4. [ä¸‰ä¸ªç»„ä»¶](#ä¸‰ä¸ªç»„ä»¶)
5. [åœ¨ ChatKit ä¸­æ³¨å†Œ](#åœ¨-chatkit-ä¸­æ³¨å†Œ)
6. [å®Œæ•´ç¤ºä¾‹](#å®Œæ•´ç¤ºä¾‹)
7. [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)
8. [æ•…éšœæ’é™¤](#æ•…éšœæ’é™¤)

---

## æ¦‚è¿°

### ä»€ä¹ˆæ˜¯ä¸Šä¸‹æ–‡æä¾›å™¨ï¼Ÿ

ä¸Šä¸‹æ–‡æä¾›å™¨ä½¿ç”¨æˆ·èƒ½å¤Ÿå°†ä¸°å¯Œçš„ä¸Šä¸‹æ–‡é™„åŠ åˆ°æ¶ˆæ¯ä¸­ã€‚æ¯ä¸ªæä¾›å™¨ç”±ä¸‰ä¸ª UI ç»„ä»¶ç»„æˆï¼š

1. **æ”¶é›†å™¨è§†å›¾** - ç”¨äºé€‰æ‹©/åˆ›å»ºä¸Šä¸‹æ–‡çš„ UIï¼ˆä¾‹å¦‚ï¼Œç…§ç‰‡é€‰æ‹©å™¨ã€ä½ç½®åœ°å›¾ã€æ–‡æœ¬è¾“å…¥ï¼‰
2. **é¢„è§ˆèŠ¯ç‰‡** - åœ¨è¾“å…¥æ¡†ä¸­æ˜¾ç¤ºçš„å°é¢„è§ˆï¼ˆä¾‹å¦‚ï¼Œç…§ç‰‡ç¼©ç•¥å›¾ã€ä½ç½®å›¾æ ‡ã€ç¬”è®°é¢„è§ˆï¼‰
3. **è¯¦æƒ…è§†å›¾** - ç”¨æˆ·ç‚¹å‡»é¢„è§ˆèŠ¯ç‰‡æ—¶æ˜¾ç¤ºçš„å…¨å±è§†å›¾ï¼ˆä¾‹å¦‚ï¼Œå®Œæ•´å›¾åƒã€å¸¦è¯¦ç»†ä¿¡æ¯çš„åœ°å›¾ã€å®Œæ•´ç¬”è®°ï¼‰

### ä¸»è¦ä¼˜åŠ¿

- **æœ€å¤§çµæ´»æ€§** - å®Œå…¨æ§åˆ¶æ‰€æœ‰ä¸‰ä¸ª UI ç»„ä»¶
- **è‡ªåŒ…å«** - æ¯ä¸ªæä¾›å™¨éƒ½æ˜¯å¯é‡ç”¨çš„"å°ç¨‹åº"
- **ç¤¾åŒºé©±åŠ¨** - é€šè¿‡ GitHubã€Swift Package Managerã€CocoaPods åˆ†äº«æä¾›å™¨
- **æ¡†æ¶å¤„ç†åŸºç¡€å·¥ä½œ** - ç‚¹å‡»æ‰‹åŠ¿ã€å±•ç¤ºã€æä¾›å™¨æŸ¥æ‰¾å…¨éƒ¨è‡ªåŠ¨å¤„ç†
- **ä¸ ChatKit é…åˆä½¿ç”¨** - ä¸ `ChatKitConversationViewController` æ— ç¼é›†æˆ

### ä½¿ç”¨æ¡ˆä¾‹ç¤ºä¾‹

- **ç…§ç‰‡** - ä»å›¾åº“é€‰æ‹©ï¼Œæ˜¾ç¤ºç¼©ç•¥å›¾ï¼Œå…¨å±é¢„è§ˆ
- **ä½ç½®** - åœ°å›¾é€‰æ‹©å™¨ï¼Œå¸¦å›¾æ ‡çš„ä½ç½®èŠ¯ç‰‡ï¼Œè¯¦ç»†åœ°å›¾è§†å›¾
- **ç¬”è®°** - æ–‡æœ¬è¾“å…¥ï¼Œç¬”è®°èŠ¯ç‰‡ï¼Œå®Œæ•´ç¬”è®°æ˜¾ç¤º
- **è‚¡ç¥¨æŠ¥ä»·** - ç¬¦å·é€‰æ‹©å™¨ï¼Œå¸¦è¶‹åŠ¿çš„ä»·æ ¼èŠ¯ç‰‡ï¼Œè¯¦ç»†å›¾è¡¨
- **å¥åº·æŒ‡æ ‡** - æŒ‡æ ‡é€‰æ‹©å™¨ï¼Œå¸¦é¢œè‰²ç¼–ç çš„å€¼èŠ¯ç‰‡ï¼Œè¶‹åŠ¿å›¾
- **è§†é¢‘/éŸ³é¢‘** - åª’ä½“é€‰æ‹©å™¨ï¼Œå¸¦æ—¶é•¿çš„ç¼©ç•¥å›¾ï¼Œæ’­æ”¾è§†å›¾
- **æ–‡æ¡£** - æ–‡ä»¶é€‰æ‹©å™¨ï¼Œå›¾æ ‡èŠ¯ç‰‡ï¼Œæ–‡æ¡£æŸ¥çœ‹å™¨
- **æ—¥å†äº‹ä»¶** - æ—¥æœŸé€‰æ‹©å™¨ï¼Œäº‹ä»¶èŠ¯ç‰‡ï¼Œå®Œæ•´äº‹ä»¶è¯¦æƒ…

---

## æ¶æ„

### åè®®ç»“æ„

ChatKit ä½¿ç”¨ ConvoUI çš„ä¸Šä¸‹æ–‡æä¾›å™¨ç³»ç»Ÿã€‚æ‚¨éœ€è¦å®ç° `ConvoUIContextProvider` åè®®ï¼š

```swift
@available(iOS 15.0, *)
public protocol ConvoUIContextProvider {
    // æä¾›å™¨æ ‡è¯†
    var id: String { get }
    var title: String { get }
    var iconName: String { get }
    var isAvailable: Bool { get }
    var priority: Int { get }
    var maximumAttachmentCount: Int { get }
    var shouldUseContainerPanel: Bool { get }
    
    // ä¸Šä¸‹æ–‡æ”¶é›†
    func makeContext() async throws -> (any ConvoUIContextItem)?
    func createCollectorView(onConfirm: @escaping ((any ConvoUIContextItem)?) -> Void) -> UIView?
    
    // é¢„è§ˆå’Œè¯¦æƒ…
    func createDetailView(for item: any ConvoUIContextItem, onDismiss: @escaping () -> Void) -> UIView?
    func localizedDescription(for item: any ConvoUIContextItem) -> String
}
```

### ä¸Šä¸‹æ–‡é¡¹ç»“æ„

æ¯ä¸ªä¸Šä¸‹æ–‡é¡¹ä»£è¡¨ä¸€ä¸ªé™„åŠ çš„ä¸Šä¸‹æ–‡ç‰‡æ®µï¼š

```swift
@available(iOS 15.0, *)
public protocol ConvoUIContextItem: Identifiable {
    var id: UUID { get }
    var providerId: String { get }  // é“¾æ¥å›æä¾›å™¨
    var type: String { get }        // ä¾‹å¦‚ "image"ã€"location"ã€"note"
    var displayName: String { get }
    
    // å¯é€‰è‡ªå®šä¹‰é¢„è§ˆï¼ˆå¦‚æœä¸º nilï¼Œæ¡†æ¶ä½¿ç”¨é»˜è®¤å€¼ï¼‰
    func createPreviewView(onRemove: @escaping () -> Void) -> UIView?
    
    // ä¼ è¾“ç¼–ç 
    func encodeForTransport() throws -> Data
    var encodingRepresentation: ConvoUIEncodingType { get }
    var encodingMetadata: [String: String]? { get }
}
```

### æ¡†æ¶èŒè´£

æ¡†æ¶è‡ªåŠ¨å¤„ç†ï¼š

- âœ… **ç‚¹å‡»æ‰‹åŠ¿** - ä¸ºé¢„è§ˆèŠ¯ç‰‡æ·»åŠ ç‚¹å‡»å¤„ç†ï¼ˆåŒ…æ‹¬è‡ªå®šä¹‰èŠ¯ç‰‡ï¼‰
- âœ… **æä¾›å™¨æŸ¥æ‰¾** - ç‚¹å‡»èŠ¯ç‰‡æ—¶é€šè¿‡ `providerId` æŸ¥æ‰¾æä¾›å™¨
- âœ… **å±•ç¤º** - å°†è¯¦æƒ…è§†å›¾åŒ…è£…åœ¨é¡µé¢è¡¨å•ä¸­
- âœ… **æ»šåŠ¨å¤„ç†** - ç¡®ä¿èŠ¯ç‰‡å¯æ»šåŠ¨åŒæ—¶ä¿æŒå¯ç‚¹å‡»
- âœ… **åˆ é™¤æŒ‰é’®** - ç‹¬ç«‹å¤„ç†åˆ é™¤æŒ‰é’®ç‚¹å‡»
- âœ… **ç¼–ç ** - å‘é€æ¶ˆæ¯æ—¶å°†ç¼–ç çš„ä¸Šä¸‹æ–‡å‘é€åˆ°åç«¯

---

## å®ç°ä¸Šä¸‹æ–‡æä¾›å™¨

### æ­¥éª¤ 1ï¼šåˆ›å»ºæä¾›å™¨ç±»

**Swiftï¼š**

```swift
import UIKit
import ConvoUI

@available(iOS 15.0, *)
final class MyContextProvider: ConvoUIContextProvider {
    var id: String { "my_provider" }
    var title: String { "My Context" }
    var iconName: String { "star.fill" }
    var isAvailable: Bool { true }
    var priority: Int { 100 }
    var maximumAttachmentCount: Int { 5 }
    var shouldUseContainerPanel: Bool { true }
    
    // å®ç°ä¸‹é¢çš„æ–¹æ³•...
}
```

**Objective-Cï¼š**

```objc
#import <Foundation/Foundation.h>
#import <UIKit/UIKit.h>
#import <ConvoUI/FinConvoComposerContextProvider.h>

@interface MyContextProvider : NSObject <FinConvoComposerContextProvider>
@end
```

### æ­¥éª¤ 2ï¼šå®ç°ä¸Šä¸‹æ–‡æ”¶é›†

é€‰æ‹©ä¸€ç§æ–¹æ³•ï¼š

**é€‰é¡¹ Aï¼šç®€å•çš„å¼‚æ­¥æ–¹æ³•**ï¼ˆç”¨äºç¨‹åºåŒ–æ”¶é›†ï¼‰ï¼š
```swift
func makeContext() async throws -> (any ConvoUIContextItem)? {
    // ç¨‹åºåŒ–æ”¶é›†ä¸Šä¸‹æ–‡
    let data = await collectData()
    return MyContextItem(data: data)
}
```

**é€‰é¡¹ Bï¼šè‡ªå®šä¹‰æ”¶é›†å™¨è§†å›¾**ï¼ˆç”¨äºåŸºäº UI çš„æ”¶é›†ï¼‰ï¼š
```swift
func createCollectorView(onConfirm: @escaping ((any ConvoUIContextItem)?) -> Void) -> UIView? {
    let collector = MyCollectorView()
    collector.onConfirm = onConfirm
    return collector
}

func makeContext() async throws -> (any ConvoUIContextItem)? {
    return nil  // å®ç° createCollectorView æ—¶ä¸ä½¿ç”¨
}
```

### æ­¥éª¤ 3ï¼šåˆ›å»ºä¸Šä¸‹æ–‡é¡¹

**Swiftï¼š**

```swift
@available(iOS 15.0, *)
struct MyContextItem: ConvoUIContextItem {
    let id = UUID()
    let providerId = "my_provider"  // å¿…é¡»ä¸ provider.id åŒ¹é…
    let type = "my_type"
    var displayName: String { "My Context" }
    
    let data: MyDataType
    
    // å¯é€‰ï¼šè‡ªå®šä¹‰é¢„è§ˆèŠ¯ç‰‡
    func createPreviewView(onRemove: @escaping () -> Void) -> UIView? {
        // è¿”å›è‡ªå®šä¹‰è§†å›¾ï¼Œæˆ– nil ä½¿ç”¨æ¡†æ¶é»˜è®¤å€¼
        return nil
    }
    
    // ç¼–ç 
    func encodeForTransport() throws -> Data {
        // ä¸ºç½‘ç»œä¼ è¾“ç¼–ç æ•°æ®
        return try JSONEncoder().encode(data)
    }
    
    var encodingRepresentation: ConvoUIEncodingType { .json }
    var encodingMetadata: [String: String]? { nil }
}
```

**Objective-Cï¼š**

```objc
@interface MyContextItem : FinConvoContextItem <FinConvoContextItemEncoding, FinConvoContextItemPreview>
@property (nonatomic, strong) NSString *myData;
@end

@implementation MyContextItem

- (instancetype)initWithData:(NSString *)data {
    self = [super init];
    if (self) {
        _myData = data;
        self.contextId = [[NSUUID UUID] UUIDString];
        self.contextType = @"my_type";
        self.providerId = @"my_provider";
        self.displayName = @"My Context";
        
        // âš ï¸ å…³é”®ï¼šè®¾ç½®ç¼–ç å¤„ç†å™¨ï¼Œä»¥ä¾¿æ¡†æ¶ä½¿ç”¨æ‚¨çš„ç¼–ç æ–¹æ³•
        // æ²¡æœ‰è¿™ä¸ªï¼Œä¸Šä¸‹æ–‡é¡¹ä¸ä¼šè¢«ç¼–ç ï¼Œä¹Ÿä¸ä¼šå‘é€åˆ°åç«¯ï¼
        self.encodingHandler = self;
        
        // âš ï¸ å…³é”®ï¼šå¦‚æœä½¿ç”¨è‡ªå®šä¹‰é¢„è§ˆè§†å›¾ï¼Œè®¾ç½®é¢„è§ˆå¤„ç†å™¨
        self.previewHandler = self;
    }
    return self;
}

// å®ç°ç¼–ç æ–¹æ³•
- (NSData *)encodeForTransport:(NSError **)error {
    NSDictionary *payload = @{ @"data": self.myData };
    return [NSJSONSerialization dataWithJSONObject:payload options:0 error:error];
}

- (FinConvoContextEncoding)encodingRepresentation {
    return FinConvoContextEncodingJSON;
}

@end
```

**âš ï¸ Objective-C çš„å…³é”®ç‚¹ï¼š** æ‚¨**å¿…é¡»**åœ¨åˆå§‹åŒ–å™¨ä¸­è®¾ç½® `self.encodingHandler = self;`ã€‚æ²¡æœ‰è¿™ä¸ªï¼Œæ¡†æ¶å°†ä¸ä¼šç¼–ç æ‚¨çš„ä¸Šä¸‹æ–‡é¡¹ï¼Œä¹Ÿä¸ä¼šå‘é€åˆ°åç«¯ï¼

### æ­¥éª¤ 4ï¼šå®ç°è¯¦æƒ…è§†å›¾

```swift
func createDetailView(for item: any ConvoUIContextItem, onDismiss: @escaping () -> Void) -> UIView? {
    guard let myItem = item as? MyContextItem else { return nil }
    
    let detailView = MyDetailView(item: myItem)
    detailView.onDismiss = onDismiss
    
    // å¦‚æœä½¿ç”¨è§†å›¾æ§åˆ¶å™¨ï¼Œä¿ç•™å®ƒï¼š
    // let controller = MyDetailViewController(item: myItem, onDismiss: onDismiss)
    // objc_setAssociatedObject(controller.view, "viewController", controller, .OBJC_ASSOCIATION_RETAIN)
    // return controller.view
    
    return detailView
}
```

---

## åœ¨ ChatKit ä¸­æ³¨å†Œ

### Swiftï¼šä½¿ç”¨ ChatKitConversationConfiguration

```swift
import FinClipChatKit
import ConvoUI

final class ChatViewController: ChatKitConversationViewController {
    init(record: ConversationRecord, conversation: Conversation, coordinator: ChatKitCoordinator) {
        var config = ChatKitConversationConfiguration.default
        config.showStatusBanner = true
        config.showWelcomeMessage = true
        
        // æ³¨å†Œä¸Šä¸‹æ–‡æä¾›å™¨
        config.contextProvidersProvider = {
            MainActor.assumeIsolated {
                [
                    ConvoUIContextProviderBridge(provider: LocationContextProvider()),
                    ConvoUIContextProviderBridge(provider: CalendarContextProvider()),
                    ConvoUIContextProviderBridge(provider: MyContextProvider())
                ]
            }
        }
        
        super.init(record: record, conversation: conversation, coordinator: coordinator, configuration: config)
    }
}
```

### Objective-Cï¼šç›´æ¥æ³¨å†Œ

ç”±äº `CKTConversationConfiguration` ä¸æš´éœ² `contextProvidersProvider`ï¼ˆå®ƒæ˜¯ Swift é—­åŒ…ï¼‰ï¼Œç›´æ¥åœ¨èŠå¤©è§†å›¾ä¸Šæ³¨å†Œæä¾›å™¨ï¼š

```objc
#import "MyContextProvider.h"
#import <FinClipChatKit/FinClipChatKit-Swift.h>
#import <ConvoUI/FinConvoMessageInputView.h>

// åˆ›å»º ChatKitConversationViewController åï¼š
ChatKitConversationViewController *chatVC = [[ChatKitConversationViewController alloc] 
    initWithObjCRecord:record
    conversation:conversation
    objcCoordinator:coordinator
    objcConfiguration:config];

// ç›´æ¥åœ¨èŠå¤©è§†å›¾ä¸Šæ³¨å†Œä¸Šä¸‹æ–‡æä¾›å™¨
dispatch_async(dispatch_get_main_queue(), ^{
    // å¦‚æœéœ€è¦ï¼ŒåŠ è½½è§†å›¾ä»¥ç¡®ä¿ chatView å¯ç”¨
    [chatVC loadViewIfNeeded];
    
    if (@available(iOS 15.0, *)) {
        MyContextProvider *myProvider = [[MyContextProvider alloc] init];
        chatVC.chatView.inputView.contextProviders = @[myProvider];
        chatVC.chatView.inputView.contextPickerEnabled = YES;
        chatVC.chatView.inputView.contextPickerMaxItems = 3;
    }
    [self.navigationController pushViewController:chatVC animated:YES];
});
```

---

## ä¸‰ä¸ªç»„ä»¶

### 1. æ”¶é›†å™¨è§†å›¾

æ”¶é›†å™¨è§†å›¾åœ¨ç”¨æˆ·ä»ä¸Šä¸‹æ–‡é€‰æ‹©å™¨èœå•ä¸­é€‰æ‹©æ‚¨çš„æä¾›å™¨æ—¶æ˜¾ç¤ºã€‚

**ä½•æ—¶ä½¿ç”¨ `createCollectorView`ï¼š**
- ç”¨æˆ·éœ€è¦ä¸ UI äº¤äº’ä»¥é€‰æ‹©ä¸Šä¸‹æ–‡
- ç¤ºä¾‹ï¼šç…§ç‰‡é€‰æ‹©å™¨ã€åœ°å›¾é€‰æ‹©å™¨ã€æ–‡ä»¶æµè§ˆå™¨ã€æ—¥æœŸé€‰æ‹©å™¨ã€æ–‡æœ¬è¾“å…¥

**ä½•æ—¶ä½¿ç”¨ `makeContext`ï¼š**
- å¯ä»¥ç¨‹åºåŒ–æ”¶é›†ä¸Šä¸‹æ–‡
- ç¤ºä¾‹ï¼šå½“å‰ä½ç½®ã€è®¾å¤‡ä¿¡æ¯ã€å‰ªè´´æ¿å†…å®¹

**æ”¶é›†å™¨è§†å›¾ç¤ºä¾‹ï¼ˆSwiftï¼‰ï¼š**

```swift
class MyCollectorView: UIView {
    var onConfirm: (((any ConvoUIContextItem)?) -> Void)?
    
    override init(frame: CGRect) {
        super.init(frame: frame)
        setupUI()
    }
    
    required init?(coder: NSCoder) {
        super.init(coder: coder)
        setupUI()
    }
    
    private func setupUI() {
        backgroundColor = .systemBackground
        
        // æ·»åŠ æ‚¨çš„ UI ç»„ä»¶
        let button = UIButton(type: .system)
        button.setTitle("Select Context", for: .normal)
        button.addTarget(self, action: #selector(handleSelect), for: .touchUpInside)
        addSubview(button)
        
        // å¸ƒå±€...
    }
    
    @objc private func handleSelect() {
        // åˆ›å»ºä¸Šä¸‹æ–‡é¡¹
        let item = MyContextItem(data: collectedData)
        onConfirm?(item)
    }
}
```

### 2. é¢„è§ˆèŠ¯ç‰‡

é¢„è§ˆèŠ¯ç‰‡å‡ºç°åœ¨è¾“å…¥æ¡†ä¸Šæ–¹çš„è¾“å…¥åŒºåŸŸï¼Œæ˜¾ç¤ºé™„åŠ çš„ä¸Šä¸‹æ–‡ã€‚

**æ¡†æ¶é»˜è®¤è¡Œä¸ºï¼š**

å¦‚æœ `createPreviewView` è¿”å› `nil`ï¼Œæ¡†æ¶æä¾›é»˜è®¤å€¼ï¼š

- **å›¾åƒç±»å‹** (`type == "image"`)ï¼š44x44 ç¼©ç•¥å›¾ï¼Œå¸¦åˆ é™¤æŒ‰é’®
- **å…¶ä»–ç±»å‹**ï¼šå¸¦ `displayName` å’Œåˆ é™¤æŒ‰é’®çš„æ–‡æœ¬èŠ¯ç‰‡

**è‡ªå®šä¹‰é¢„è§ˆï¼š**

è¿”å›è‡ªå®šä¹‰è§†å›¾ä»¥è¿›è¡Œç‹¬ç‰¹æ ·å¼è®¾è®¡ã€‚æ¡†æ¶è‡ªåŠ¨æ·»åŠ ç‚¹å‡»å¤„ç†ï¼š

```swift
func createPreviewView(onRemove: @escaping () -> Void) -> UIView? {
    let container = UIView(frame: CGRect(x: 0, y: 0, width: 80, height: 40))
    container.backgroundColor = .systemBlue.withAlphaComponent(0.1)
    container.layer.cornerRadius = 8
    
    // å›¾æ ‡
    let icon = UILabel(frame: CGRect(x: 8, y: 10, width: 20, height: 20))
    icon.text = "ğŸ“"
    container.addSubview(icon)
    
    // æ ‡ç­¾
    let label = UILabel(frame: CGRect(x: 32, y: 0, width: 40, height: 40))
    label.text = displayName
    container.addSubview(label)
    
    // åˆ é™¤æŒ‰é’®
    let removeButton = UIButton(type: .system)
    removeButton.frame = CGRect(x: 60, y: 10, width: 20, height: 20)
    removeButton.setTitle("âœ•", for: .normal)
    removeButton.addAction(UIAction { _ in onRemove() }, for: .touchUpInside)
    container.addSubview(removeButton)
    
    return container
}
```

**é‡è¦æç¤ºï¼š**

- âœ… æ¡†æ¶è‡ªåŠ¨æ·»åŠ ç‚¹å‡»æ‰‹åŠ¿ä»¥æ‰“å¼€è¯¦æƒ…è§†å›¾
- âœ… æ¡†æ¶å¤„ç†æ»šåŠ¨è§†å›¾äº¤äº’
- âœ… åˆ é™¤æŒ‰é’®ç‹¬ç«‹å·¥ä½œ
- âœ… æ— éœ€è‡ªå·±ç®¡ç†ç‚¹å‡»æ‰‹åŠ¿

### 3. è¯¦æƒ…è§†å›¾

è¯¦æƒ…è§†å›¾åœ¨ç”¨æˆ·ç‚¹å‡»é¢„è§ˆèŠ¯ç‰‡æ—¶æ˜¾ç¤ºã€‚

**ç®€å• UIView æ–¹æ³•ï¼š**

```swift
class MyDetailView: UIView {
    var onDismiss: (() -> Void)?
    
    init(item: MyContextItem) {
        super.init(frame: .zero)
        setupUI(item: item)
    }
    
    required init?(coder: NSCoder) {
        fatalError("init(coder:) has not been implemented")
    }
    
    private func setupUI(item: MyContextItem) {
        backgroundColor = .systemBackground
        
        // å…³é—­æŒ‰é’®
        let closeButton = UIButton(type: .system)
        closeButton.setTitle("Close", for: .normal)
        closeButton.addTarget(self, action: #selector(handleClose), for: .touchUpInside)
        addSubview(closeButton)
        
        // æ‚¨çš„å†…å®¹
        // ...
        
        // å¸ƒå±€...
    }
    
    @objc private func handleClose() {
        onDismiss?()
    }
}
```

**UIViewController æ–¹æ³•ï¼š**

å¦‚æœæ‚¨éœ€è¦è§†å›¾æ§åˆ¶å™¨ç”Ÿå‘½å‘¨æœŸï¼š

```swift
class MyDetailViewController: UIViewController {
    private let onDismiss: () -> Void
    
    init(item: MyContextItem, onDismiss: @escaping () -> Void) {
        self.onDismiss = onDismiss
        super.init(nibName: nil, bundle: nil)
        setupUI(item: item)
    }
    
    required init?(coder: NSCoder) {
        fatalError("init(coder:) has not been implemented")
    }
    
    private func setupUI(item: MyContextItem) {
        view.backgroundColor = .systemBackground
        // è®¾ç½® UI...
    }
    
    @objc private func handleClose() {
        onDismiss()
    }
}

// åœ¨æä¾›å™¨ä¸­ï¼š
func createDetailView(for item: any ConvoUIContextItem, onDismiss: @escaping () -> Void) -> UIView? {
    guard let myItem = item as? MyContextItem else { return nil }
    
    let controller = MyDetailViewController(item: myItem, onDismiss: onDismiss)
    
    // å…³é”®ï¼šä¿ç•™æ§åˆ¶å™¨
    objc_setAssociatedObject(controller.view, "viewController", controller, .OBJC_ASSOCIATION_RETAIN)
    
    return controller.view
}
```

---

## å®Œæ•´ç¤ºä¾‹

### Swift ç¤ºä¾‹

**ä½ç½®æä¾›å™¨ï¼š**
- å‚è§ `demo-apps/iOS/Simple/App/Extensions/LocationContextProvider.swift`
- å¸¦ `MKMapView` å’Œæœç´¢çš„è‡ªå®šä¹‰æ”¶é›†å™¨è§†å›¾
- å¸¦ ğŸ“ å›¾æ ‡çš„è‡ªå®šä¹‰é¢„è§ˆèŠ¯ç‰‡
- å¸¦åœ°å›¾çš„è‡ªå®šä¹‰è¯¦æƒ…è§†å›¾

**æ—¥å†æä¾›å™¨ï¼š**
- å‚è§ `demo-apps/iOS/Simple/App/Extensions/CalendarContextProvider.swift`
- å¸¦äº‹ä»¶åˆ—è¡¨çš„è‡ªå®šä¹‰æ”¶é›†å™¨è§†å›¾
- å¸¦æ—¥å†å›¾æ ‡çš„è‡ªå®šä¹‰é¢„è§ˆèŠ¯ç‰‡
- å¸¦äº‹ä»¶è¯¦æƒ…çš„è‡ªå®šä¹‰è¯¦æƒ…è§†å›¾

### Objective-C ç¤ºä¾‹

**ç¬”è®°æä¾›å™¨ï¼š**
- å‚è§ `demo-apps/iOS/SimpleObjC/App/ContextProviders/NoteContextProvider.h/m`
- å®Œæ•´çš„ Objective-C å®ç°ï¼Œæ¼”ç¤ºï¼š
  - è‡ªå®šä¹‰æ”¶é›†å™¨è§†å›¾ï¼ˆæ–‡æœ¬è¾“å…¥ï¼‰
  - è‡ªå®šä¹‰é¢„è§ˆèŠ¯ç‰‡ï¼ˆæ ·å¼åŒ–ç¬”è®°é¢„è§ˆï¼‰
  - è‡ªå®šä¹‰è¯¦æƒ…è§†å›¾ï¼ˆå®Œæ•´ç¬”è®°æ˜¾ç¤ºï¼‰
  - æ­£ç¡®è®¾ç½® `encodingHandler` çš„ç¼–ç 
  - åœ¨ `ConversationListViewController` ä¸­æ³¨å†Œ

---

## æœ€ä½³å®è·µ

### 1. æä¾›å™¨æ ‡è¯†

**å§‹ç»ˆè®¾ç½®å”¯ä¸€çš„ `providerId`ï¼š**

```swift
// åœ¨æä¾›å™¨ä¸­
var id: String { "my_unique_provider_id" }

// åœ¨ä¸Šä¸‹æ–‡é¡¹ä¸­
let providerId = "my_unique_provider_id"  // å¿…é¡»åŒ¹é…ï¼
```

è¿™ç¡®ä¿æ¡†æ¶åœ¨æ˜¾ç¤ºè¯¦æƒ…è§†å›¾æ—¶èƒ½æ­£ç¡®åŒ¹é…é¡¹åˆ°æä¾›å™¨ã€‚

### 2. ç¼–ç å¤„ç†å™¨ï¼ˆå…³é”®ï¼ï¼‰

**âš ï¸ æœ€å¸¸è§é—®é¢˜ï¼š** ä¸Šä¸‹æ–‡é¡¹æœªå‘é€åˆ°åç«¯ã€‚

**å¯¹äº Swiftï¼š** å½“æ‚¨å®ç° `ConvoUIContextItem` æ—¶ï¼Œæ¡†æ¶è‡ªåŠ¨ä½¿ç”¨æ‚¨çš„ç¼–ç æ–¹æ³•ã€‚

**å¯¹äº Objective-Cï¼š** æ‚¨**å¿…é¡»**è®¾ç½® `encodingHandler` å±æ€§ï¼š

```objc
// åœ¨æ‚¨çš„ä¸Šä¸‹æ–‡é¡¹çš„ init æ–¹æ³•ä¸­ï¼š
self.encodingHandler = self;  // ç¼–ç å·¥ä½œæ‰€å¿…éœ€ï¼
```

**ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªï¼š**

æ¡†æ¶æ£€æŸ¥ `item.encodingHandler` ä»¥ç¡®å®šæ˜¯å¦åº”ç¼–ç ä¸Šä¸‹æ–‡é¡¹ã€‚å¦‚æœ `encodingHandler` ä¸º `nil`ï¼Œæ¡†æ¶å‡å®šé¡¹ä¸éœ€è¦ç¼–ç ï¼Œä¸ä¼šè°ƒç”¨æ‚¨çš„ `encodeForTransport:` æ–¹æ³•ã€‚

**éªŒè¯æ¸…å•ï¼š**

- âœ… åœ¨åˆå§‹åŒ–å™¨ä¸­è®¾ç½® `encodingHandler` ä¸º `self`ï¼ˆObjective-Cï¼‰
- âœ… ä¸Šä¸‹æ–‡é¡¹ç¬¦åˆ `FinConvoContextItemEncoding` åè®®ï¼ˆObjective-Cï¼‰æˆ– `ConvoUIContextItem`ï¼ˆSwiftï¼‰
- âœ… `encodeForTransport:` è¿”å›æœ‰æ•ˆçš„ `NSData`ï¼ˆObjective-Cï¼‰æˆ– `Data`ï¼ˆSwiftï¼‰
- âœ… `encodingRepresentation` è¿”å›æ­£ç¡®çš„ç¼–ç ç±»å‹
- âœ… é€šè¿‡å‘é€æ¶ˆæ¯å¹¶æ£€æŸ¥åç«¯æ˜¯å¦æ”¶åˆ°ä¸Šä¸‹æ–‡æ¥æµ‹è¯•

### 3. é¢„è§ˆèŠ¯ç‰‡è®¾è®¡

**æŒ‡å—ï¼š**
- ä¿æŒèŠ¯ç‰‡ç´§å‡‘ï¼ˆ36-80pt å®½åº¦ï¼Œ36-44pt é«˜åº¦ï¼‰
- ä½¿ç”¨æ¸…æ™°çš„è§†è§‰æŒ‡ç¤ºå™¨ï¼ˆå›¾æ ‡ã€é¢œè‰²ï¼‰
- ç¡®ä¿åˆ é™¤æŒ‰é’®æ˜“äºç‚¹å‡»
- åœ¨æ»šåŠ¨è§†å›¾ä¸­æµ‹è¯•ï¼ˆèŠ¯ç‰‡æ°´å¹³æ»šåŠ¨ï¼‰

**æ— éšœç¢æ€§ï¼š**
- åœ¨è‡ªå®šä¹‰é¢„è§ˆè§†å›¾ä¸Šè®¾ç½® `accessibilityLabel`
- ç¡®ä¿è¶³å¤Ÿçš„å¯¹æ¯”åº¦
- å¦‚æœä½¿ç”¨æ–‡æœ¬ï¼Œæ”¯æŒåŠ¨æ€ç±»å‹

### 4. è¯¦æƒ…è§†å›¾ç”Ÿå‘½å‘¨æœŸ

**å¦‚æœä½¿ç”¨ UIViewControllerï¼š**
- å§‹ç»ˆä½¿ç”¨ `objc_setAssociatedObject` ä¿ç•™æ§åˆ¶å™¨
- ç”¨æˆ·å…³é—­æ—¶è°ƒç”¨ `onDismiss()`
- ä¸è¦è‡ªå·±ä»¥æ¨¡æ€æ–¹å¼å±•ç¤ºï¼ˆæ¡†æ¶å¤„ç†ï¼‰

**å¦‚æœä½¿ç”¨ UIViewï¼š**
- å®ç° `onDismiss` å›è°ƒ
- æ­£ç¡®å¤„ç†å¸ƒå±€çº¦æŸ
- æ”¯æŒå®‰å…¨åŒºåŸŸ

### 5. é”™è¯¯å¤„ç†

**æ”¶é›†é”™è¯¯ï¼š**
```swift
func makeContext() async throws -> (any ConvoUIContextItem)? {
    do {
        let data = try await collectData()
        return MyContextItem(data: data)
    } catch {
        // è®°å½•é”™è¯¯ã€æ˜¾ç¤ºè­¦æŠ¥æˆ–è¿”å› nil
        return nil
    }
}
```

### 6. æ€§èƒ½

**å»¶è¿ŸåŠ è½½ï¼š**
- åœ¨æ˜¾ç¤ºè¯¦æƒ…è§†å›¾ä¹‹å‰ä¸è¦åŠ è½½å¤§é‡æ•°æ®
- é¢„è§ˆèŠ¯ç‰‡ä½¿ç”¨ç¼©ç•¥å›¾
- ç¼–ç å‰å‹ç¼©å›¾åƒ

**å†…å­˜ç®¡ç†ï¼š**
- è¯¦æƒ…è§†å›¾å…³é—­æ—¶é‡Šæ”¾èµ„æº
- åœ¨é—­åŒ…ä¸­ä½¿ç”¨å¼±å¼•ç”¨
- é€‚å½“æ¸…é™¤ç¼“å­˜

### 7. æœ¬åœ°åŒ–

**æä¾›å™¨å…ƒæ•°æ®ï¼š**
```swift
var title: String { 
    NSLocalizedString("context.my_provider", comment: "My Provider")
}
```

**ä¸Šä¸‹æ–‡æè¿°ï¼š**
```swift
func localizedDescription(for item: any ConvoUIContextItem) -> String {
    // è¿”å›ç”¨äºåå¤‡æ–‡æœ¬é¢„è§ˆçš„æœ¬åœ°åŒ–æè¿°
    return NSLocalizedString("context.my_provider.description", comment: "")
}
```

---

## æ•…éšœæ’é™¤

### é¢„è§ˆèŠ¯ç‰‡ä¸å¯ç‚¹å‡»

**é—®é¢˜ï¼š** ç‚¹å‡»é¢„è§ˆèŠ¯ç‰‡ä¸ä¼šæ‰“å¼€è¯¦æƒ…è§†å›¾ã€‚

**è§£å†³æ–¹æ¡ˆï¼š**
- ç¡®ä¿ `providerId` åœ¨æä¾›å™¨å’Œé¡¹ä¹‹é—´åŒ¹é…
- æ£€æŸ¥ `createDetailView` æ˜¯å¦è¿”å›é nil è§†å›¾
- éªŒè¯æ¡†æ¶æ˜¯å¦å·²æ·»åŠ ç‚¹å‡»æ‰‹åŠ¿ï¼ˆæ£€æŸ¥æ—¥å¿—ï¼‰
- ç¡®ä¿è‡ªå®šä¹‰é¢„è§ˆè§†å›¾çš„ `userInteractionEnabled = true`

### è¯¦æƒ…è§†å›¾æœªæ˜¾ç¤º

**é—®é¢˜ï¼š** ç‚¹å‡»èŠ¯ç‰‡æ—¶è¯¦æƒ…è§†å›¾ä¸å‡ºç°ã€‚

**è§£å†³æ–¹æ¡ˆï¼š**
- æ£€æŸ¥æä¾›å™¨æŸ¥æ‰¾æ—¥å¿—ä»¥éªŒè¯æ˜¯å¦æ‰¾åˆ°æä¾›å™¨
- ç¡®ä¿å®ç°äº† `createDetailView`
- å¦‚æœä½¿ç”¨ UIViewControllerï¼ŒéªŒè¯æ§åˆ¶å™¨æ˜¯å¦å·²ä¿ç•™
- æ£€æŸ¥ `onDismiss` å›è°ƒæ˜¯å¦æ­£ç¡®è¿æ¥

### è‡ªå®šä¹‰é¢„è§ˆæœªå‡ºç°

**é—®é¢˜ï¼š** æœªæ˜¾ç¤ºè‡ªå®šä¹‰é¢„è§ˆèŠ¯ç‰‡ï¼Œè€Œæ˜¯ä½¿ç”¨é»˜è®¤å€¼ã€‚

**è§£å†³æ–¹æ¡ˆï¼š**
- éªŒè¯ `createPreviewView` æ˜¯å¦è¿”å›é nil è§†å›¾
- æ£€æŸ¥è§†å›¾æ˜¯å¦æœ‰æœ‰æ•ˆçš„æ¡†æ¶æˆ–çº¦æŸ
- ç¡®ä¿åœ¨è¿”å›ä¹‹å‰æ­£ç¡®é…ç½®è§†å›¾
- é¦–å…ˆä½¿ç”¨æ¡†æ¶çš„é»˜è®¤å€¼è¿›è¡Œæµ‹è¯•ï¼Œç„¶åæ·»åŠ è‡ªå®šä¹‰

### åˆ é™¤æŒ‰é’®ä¸å·¥ä½œ

**é—®é¢˜ï¼š** åˆ é™¤æŒ‰é’®ï¼ˆÃ—ï¼‰ä¸ä¼šåˆ é™¤ä¸Šä¸‹æ–‡é¡¹ã€‚

**è§£å†³æ–¹æ¡ˆï¼š**
- éªŒè¯ `onRemove` å›è°ƒæ˜¯å¦è¢«è°ƒç”¨
- æ£€æŸ¥æŒ‰é’®æ˜¯å¦è¢«å…¶ä»–è§†å›¾è¦†ç›–
- ç¡®ä¿æŒ‰é’®å·²æ·»åŠ åˆ°é¢„è§ˆè§†å›¾å±‚æ¬¡ç»“æ„ä¸­
- é¦–å…ˆä½¿ç”¨æ¡†æ¶çš„é»˜è®¤é¢„è§ˆè¿›è¡Œæµ‹è¯•

### æä¾›å™¨ä¸åœ¨èœå•ä¸­

**é—®é¢˜ï¼š** æä¾›å™¨æœªå‡ºç°åœ¨ä¸Šä¸‹æ–‡é€‰æ‹©å™¨èœå•ä¸­ã€‚

**è§£å†³æ–¹æ¡ˆï¼š**
- æ£€æŸ¥ `isAvailable` æ˜¯å¦è¿”å› `true`
- éªŒè¯æä¾›å™¨æ˜¯å¦å·²æ·»åŠ åˆ° `contextProviders` æ•°ç»„
- ç¡®ä¿ `contextPickerEnabled` ä¸º `true`
- æ£€æŸ¥ `priority` å€¼ï¼ˆè¶Šé«˜ = è¶Šå…ˆå‡ºç°ï¼‰

### ä¸Šä¸‹æ–‡æœªå‘é€åˆ°åç«¯

**é—®é¢˜ï¼š** ä¸Šä¸‹æ–‡é¡¹å‡ºç°åœ¨ UI ä¸­ï¼Œä½†æœªåŒ…å«åœ¨å‘é€åˆ°åç«¯çš„æ¶ˆæ¯ä¸­ã€‚

**è§£å†³æ–¹æ¡ˆï¼š**
- **Objective-Cï¼š** éªŒè¯ `encodingHandler` æ˜¯å¦åœ¨ä¸Šä¸‹æ–‡é¡¹çš„åˆå§‹åŒ–å™¨ä¸­è®¾ç½®ä¸º `self`
- æ£€æŸ¥ä¸Šä¸‹æ–‡é¡¹æ˜¯å¦ç¬¦åˆ `FinConvoContextItemEncoding` åè®®ï¼ˆObjective-Cï¼‰æˆ– `ConvoUIContextItem`ï¼ˆSwiftï¼‰
- éªŒè¯ `encodeForTransport:` æ–¹æ³•æ˜¯å¦è¿”å›æœ‰æ•ˆçš„ `NSData`ï¼ˆä¸ä¸º nilï¼‰
- æ£€æŸ¥ `encodingRepresentation` æ˜¯å¦è¿”å›æ­£ç¡®çš„ç¼–ç ç±»å‹
- ç›´æ¥æµ‹è¯•ç¼–ç æ–¹æ³•ï¼š`NSData *data = [item.encodingHandler encodeForTransport:&error];`ï¼ˆObjective-Cï¼‰
- æ£€æŸ¥æ¡†æ¶æ—¥å¿—ä¸­çš„ç¼–ç é”™è¯¯
- éªŒè¯å‘é€æ¶ˆæ¯æ—¶ `item.encodingHandler` ä¸ä¸º `nil`ï¼ˆObjective-Cï¼‰

**å¸¸è§é”™è¯¯ï¼š**
- âŒ åœ¨ Objective-C ä¸­å¿˜è®°è®¾ç½® `self.encodingHandler = self;`
- âŒ `encodeForTransport:` è¿”å› `nil` æˆ–æŠ›å‡ºé”™è¯¯
- âŒ ä¸ç¬¦åˆ `FinConvoContextItemEncoding` åè®®ï¼ˆObjective-Cï¼‰
- âŒ åœ¨åˆ›å»ºé¡¹åè®¾ç½® `encodingHandler`ï¼ˆå¿…é¡»åœ¨ `init` ä¸­ï¼‰

---

## ç›¸å…³æ–‡æ¡£

- **[å¼€å‘è€…æŒ‡å—](./developer-guide.zh.md)** - å®Œæ•´çš„ ChatKit å¼€å‘æŒ‡å—
- **[Objective-C æŒ‡å—](./objective-c-guide.zh.md)** - Objective-C ç‰¹å®šæ¨¡å¼
- **[UI è‡ªå®šä¹‰](../../how-to/customize-ui.zh.md)** - è¾“å…¥æ¡†åŠŸèƒ½æ¦‚è¿°
- **[ç¤ºä¾‹](../../../demo-apps/iOS/)** - æ¼”ç¤ºåº”ç”¨ä¸­çš„å·¥ä½œç¤ºä¾‹

---

## æ¼”ç¤ºåº”ç”¨

å®Œæ•´çš„å·¥ä½œç¤ºä¾‹å¯åœ¨æ¼”ç¤ºåº”ç”¨ä¸­æ‰¾åˆ°ï¼š

- **Simple (Swift)ï¼š** `demo-apps/iOS/Simple/App/Extensions/`
  - `LocationContextProvider.swift`
  - `CalendarContextProvider.swift`
  
- **SimpleObjC (Objective-C)ï¼š** `demo-apps/iOS/SimpleObjC/App/ContextProviders/`
  - `NoteContextProvider.h/m` - å®Œæ•´çš„ Objective-C ç¤ºä¾‹

---

**æœ€åæ›´æ–°**ï¼š2025 å¹´ 11 æœˆ  
**ChatKit ç‰ˆæœ¬**ï¼š0.9.0+

